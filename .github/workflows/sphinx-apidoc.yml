name: Publish Github Pages Sphinx

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build-docs:
    runs-on: ubuntu-latest

    steps:
    # 1. Checkout your repository
    - name: Checkout repository
      uses: actions/checkout@v3

    # 2. Set up Python
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    # 3. Install GDAL and Spatialite system dependencies
    - name: Install GDAL and Spatialite system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y gdal-bin libgdal-dev libsqlite3-mod-spatialite

    # 4. Set GDAL environment variables
    - name: Set GDAL environment variables
      run: |
        export CPLUS_INCLUDE_PATH=/usr/include/gdal
        export C_INCLUDE_PATH=/usr/include/gdal

    # 5. Clear pip cache (optional but recommended for a clean build)
    - name: Clear pip cache
      run: |
        sudo rm -rf ~/.cache/pip

    # 6. Set environment variables (for EXTRA_CONTRIB_APPS)
    - name: Set environment variables
      run: |
        echo "EXTRA_CONTRIB_APPS=[]" >> $GITHUB_ENV

    # 7. Install Python dependencies in a virtual environment
    - name: Install dependencies
      run: |
        python -m venv venv
        source venv/bin/activate
        python -m pip install --upgrade pip
        pip install -r docs/requirements.txt

    # 8. Run database migrations
    - name: Run database migrations
      run: |
        source venv/bin/activate
        python manage.py migrate

    # 9. Run sphinx-apidoc
    - name: Generate API documentation
      run: |
        source venv/bin/activate
        sphinx-apidoc -o docs ./

    # 10. Build the HTML docs
    - name: Build HTML documentation
      run: |
        source venv/bin/activate
        sphinx-build -b html docs docs/_build/html

    # 11. Commit and push the generated documentation
    - name: Commit and push changes
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
        git add -f docs/_build/html docs/*.rst
        git commit -m "Auto-update documentation" || echo "No changes to commit"  # Commit si hay cambios
        git pull --rebase origin main  # Traer los cambios remotos
        git push origin HEAD:main  # Forzar el push a la rama main
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
