name: Publish Github Pages Sphinx

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build-docs:
    runs-on: ubuntu-latest

    steps:
    # 1. Checkout your repository
    - name: Checkout repository
      uses: actions/checkout@v3

    # 2. Set up Python
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    # 3. Install GDAL system dependencies
    - name: Install GDAL system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y gdal-bin libgdal-dev

    # 4. Set GDAL environment variables (optional but often needed)
    - name: Set GDAL environment variables
      run: |
        export CPLUS_INCLUDE_PATH=/usr/include/gdal
        export C_INCLUDE_PATH=/usr/include/gdal

    # 5. Install Python dependencies (including GDAL)
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r docs/requirements.txt

    # 6. Run sphinx-apidoc
    - name: Generate API documentation
      run: |
        sphinx-apidoc -o docs ./

    # 7. Build the HTML docs (opcional)
    - name: Build HTML documentation
      run: |
        sphinx-build -b html docs docs/_build/html

    # 8. Commit and push the generated documentation
    #- name: Commit and push changes
    #  run: |
    #    git config --global user.name 'github-actions[bot]'
    #    git config --global user.email 'github-actions[bot]@users.noreply.github.com'
    #    git add docs/_build/html docs/*.rst
    #    git commit -m "Auto-update documentation"
    #    git push origin HEAD:main  # Forzar el push a la rama main
    #  env:
    #    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: docs/_build/html

